<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lakehouse Inn - Voice of Customer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #fafafa;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-card-hover: #f5f5f5;
            --text-primary: #1a1a1a;
            --text-secondary: #757575;
            --accent-primary: #ff5733;
            --accent-secondary: #ff7849;
            --accent-hover: #e64a2e;
            --status-critical: #d32f2f;
            --status-warning: #f9a825;
            --status-good: #43a047;
            --border-subtle: #e0e0e0;
            --border-light: #eeeeee;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 2px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            max-width: 1400px; 
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 32px;
            position: relative;
            z-index: 1;
        }

        .logo {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }
        
        .persona-badge { 
            padding: 8px 20px;
            background: var(--bg-card);
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--accent-primary);
            border: 1px solid var(--border-subtle);
            letter-spacing: 0.01em;
        }
        
        /* Main Content */
        .main-content {
            max-width: 1400px; 
            margin: 0 auto;
            padding: 40px 32px;
            position: relative;
            z-index: 1;
        }

        .screen {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }
        
        .screen.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .screen-title {
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            letter-spacing: -0.03em;
        }

        .screen-subtitle {
            font-size: 1.125rem;
            color: var(--text-secondary);
            margin-bottom: 40px;
            font-weight: 400;
        }
        
        /* Buttons */
        .action-button {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 6px 4px;
            letter-spacing: 0.01em;
        }

        .action-button:hover {
            background: var(--accent-hover);
            box-shadow: var(--shadow-md);
        }
        
        .action-button:active {
            transform: scale(0.98);
        }
        
        .action-button.secondary { 
            background: var(--bg-card);
            color: var(--accent-primary);
            border: 1px solid var(--border-subtle);
        }
        
        .action-button.secondary:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
        }
        
        /* Role Selection */
        .role-selection { 
            text-align: center;
            padding: 80px 20px;
            display: flex;
            gap: 32px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .role-button { 
            padding: 48px 64px;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            color: var(--text-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            font-size: 1.75rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: -0.02em;
            position: relative;
            overflow: hidden;
        }
        
        .role-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--accent-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }
        
        .role-button:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-primary);
        }
        
        .role-button:hover::before {
            opacity: 0.08;
        }
        
        /* Data Scale Banner */
        .scale-banner {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 28px 32px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: var(--shadow-sm);
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .scale-item {
            text-align: center;
            flex: 1;
            min-width: 150px;
        }
        
        .scale-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--accent-primary);
            line-height: 1;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .scale-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .scale-divider {
            width: 1px;
            height: 60px;
            background: linear-gradient(180deg, transparent, var(--border-subtle), transparent);
        }
        
        /* Summary Dashboard */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 24px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }
        
        .summary-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--accent-primary);
        }
        
        .metric-card {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .metric-icon-box {
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 14px;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }
        
        .metric-icon-box.default {
            background: rgba(255, 87, 51, 0.1);
            color: var(--accent-primary);
        }
        
        .metric-icon-box.critical {
            background: rgba(211, 47, 47, 0.1);
            color: var(--status-critical);
        }
        
        .metric-icon-box.warning {
            background: rgba(249, 168, 37, 0.1);
            color: var(--status-warning);
        }
        
        .metric-icon-box.healthy {
            background: rgba(67, 160, 71, 0.1);
            color: var(--status-good);
        }
        
        .summary-card:hover .metric-icon-box {
            transform: scale(1.1) rotate(5deg);
        }
        
        .metric-content {
            flex: 1;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
            margin-bottom: 4px;
        }
        
        .metric-change {
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .metric-change.positive {
            color: var(--status-good);
        }
        
        .metric-change.positive::before {
            content: '↗';
        }
        
        .metric-change.negative {
            color: var(--status-critical);
        }
        
        .metric-change.negative::before {
            content: '↘';
        }
        
        .critical-metric {
            border-left: 4px solid var(--status-critical);
        }
        
        .warning-metric {
            border-left: 4px solid var(--status-warning);
        }
        
        .healthy-metric {
            border-left: 4px solid var(--status-good);
        }
        
        /* Insights Grid */
        .insights-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .insights-card {
            padding: 28px;
        }
        
        .tall-card {
            display: flex;
            flex-direction: column;
        }
        
        /* Property Map */
        .map-card {
            padding: 24px;
            height: 600px;
            display: flex;
            flex-direction: column;
        }
        
        .property-map {
            position: relative;
            background: #fafafa;
            border-radius: 6px;
            padding: 20px;
            border: 1px solid var(--border-light);
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0; /* Important for flex child scrolling */
        }
        
        .property-map svg {
            display: block;
            width: 100%;
            height: 100%;
            max-height: 100%;
        }
        
        /* Full screen map controls */
        .map-controls {
            position: absolute;
            top: 30px;
            right: 30px;
            z-index: 100;
            display: flex;
            gap: 8px;
        }
        
        .map-control-btn {
            background: white;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        
        .map-control-btn:hover {
            background: var(--bg-card-hover);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .map-control-btn svg {
            width: 16px;
            height: 16px;
        }
        
        /* Full screen mode */
        .property-map.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            border-radius: 0;
            padding: 0;
            z-index: 9999;
            border: none;
        }
        
        .property-map.fullscreen svg {
            border-radius: 0;
        }
        
        .map-marker {
            cursor: pointer;
            transition: all 0.2s ease;
            stroke: white;
            stroke-width: 2;
        }
        
        .map-marker:hover {
            transform: scale(1.4);
            filter: brightness(1.1);
        }
        
        .map-marker.critical {
            fill: var(--status-critical);
            filter: url(#glow-critical);
        }
        
        .map-marker.warning {
            fill: var(--status-warning);
            filter: url(#glow-warning);
        }
        
        .map-marker.healthy {
            fill: var(--status-good);
        }
        
        .map-legend {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-subtle);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .legend-dot.critical {
            background: var(--status-critical);
        }
        
        .legend-dot.warning {
            background: var(--status-warning);
        }
        
        .legend-dot.healthy {
            background: var(--status-good);
        }
        
        .map-tooltip {
            position: fixed;
            background: var(--text-primary);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s ease;
            z-index: 10000;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .insights-header {
            margin-bottom: 20px;
        }
        
        .insights-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .insights-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .insights-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .insight-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .insight-item:hover {
            background: rgba(255, 255, 255, 0.9);
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }
        
        .insight-content {
            flex: 1;
        }
        
        .insight-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .insight-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .insight-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .insight-badge.critical {
            background: rgba(211, 47, 47, 0.1);
            color: var(--status-critical);
            border: 1px solid rgba(211, 47, 47, 0.3);
        }
        
        .insight-badge.warning {
            background: rgba(249, 168, 37, 0.1);
            color: var(--status-warning);
            border: 1px solid rgba(249, 168, 37, 0.3);
        }
        
        .insight-badge.info {
            background: rgba(255, 87, 51, 0.1);
            color: var(--accent-primary);
            border: 1px solid rgba(255, 87, 51, 0.3);
        }
        
        /* Section Divider */
        .section-divider {
            margin: 48px 0 24px 0;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-subtle);
        }
        
        .section-divider h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }
        
        /* Property Groups */
        .property-group { 
            margin-bottom: 40px;
        }
        
        .group-header { 
            font-size: 0.875rem;
            padding: 12px 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .group-header::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .group-critical { 
            background: rgba(255, 107, 107, 0.15);
            color: var(--status-critical);
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        
        .group-critical::before { background: var(--status-critical); }
        
        .group-warning { 
            background: rgba(255, 217, 61, 0.15);
            color: var(--status-warning);
            border: 1px solid rgba(255, 217, 61, 0.3);
        }
        
        .group-warning::before { background: var(--status-warning); }
        
        .group-good { 
            background: rgba(81, 207, 102, 0.15);
            color: var(--status-good);
            border: 1px solid rgba(81, 207, 102, 0.3);
        }
        
        .group-good::before { background: var(--status-good); }
        
        /* Property Cards */
        .property-row { 
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            margin-bottom: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .property-row:hover { 
            box-shadow: var(--shadow-md);
            border-color: var(--accent-primary);
        }
        
        .property-row.expanded { 
            border-left: 3px solid var(--accent-primary);
            box-shadow: var(--shadow-md);
        }
        
        .property-header { 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .property-name {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: -0.01em;
        }
        
        .property-summary { 
            color: var(--text-secondary);
            margin-top: 8px;
            font-size: 0.9375rem;
        }
        
        .property-actions { 
            margin-top: 20px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        /* Accordion Details - Smooth Animation */
        .property-details { 
            display: grid;
            grid-template-rows: 0fr;
            margin-top: 0;
            padding-top: 0;
            border-top: 1px solid transparent;
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
        }
        
        .property-details > div {
            overflow: hidden;
        }
        
        .property-details.active {
            grid-template-rows: 1fr;
            margin-top: 24px;
            padding-top: 24px;
            border-top-color: var(--border-subtle);
        }
        
        @keyframes slideDown {
            from { 
                opacity: 0;
                transform: translateY(-10px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .check-item { 
            background: #f9fafb;
            padding: 20px;
            margin-bottom: 12px;
            border-radius: 12px;
            border-left: 3px solid var(--border-subtle);
            transition: all 0.3s ease;
        }
        
        .check-item:hover {
            background: #f3f4f6;
        }
        
        .check-item.failed { border-left-color: var(--status-critical); }
        .check-item.warning { border-left-color: var(--status-warning); }
        .check-item.green { border-left-color: var(--status-good); }
        
        .check-header { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .check-name { 
            font-weight: 600;
            font-size: 1rem;
            letter-spacing: -0.01em;
        }
        
        .check-status { 
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status-failed { 
            background: rgba(255, 107, 107, 0.2);
            color: var(--status-critical);
            border: 1px solid rgba(255, 107, 107, 0.4);
        }
        
        .status-warning { 
            background: rgba(255, 217, 61, 0.2);
            color: var(--status-warning);
            border: 1px solid rgba(255, 217, 61, 0.4);
        }
        
        .status-green { 
            background: rgba(81, 207, 102, 0.2);
            color: var(--status-good);
            border: 1px solid rgba(81, 207, 102, 0.4);
        }
        
        .check-diagnosis { 
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-size: 0.9375rem;
        }
        
        .check-solution { 
            color: var(--accent-primary);
            font-style: italic;
            font-size: 0.9375rem;
        }
        
        /* Dashboard Cards */
        .dashboard-filter { 
            background: var(--bg-card);
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-sm);
        }
        
        .filter-row { 
            display: flex;
            gap: 16px; 
            align-items: center;
            margin-bottom: 16px;
        }
        
        .filter-row:last-child { margin-bottom: 0; }
        
        .filter-label { 
            font-weight: 500;
            min-width: 100px;
            font-size: 0.9375rem;
            color: var(--text-secondary);
        }
        
        .filter-input { 
            padding: 12px 16px;
            background: #f3f4f6;
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            border-radius: 10px;
            flex: 1;
            font-size: 0.9375rem;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }
        
        .filter-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: var(--bg-secondary);
            box-shadow: 0 0 0 3px rgba(255, 87, 51, 0.1);
        }
        
        .dashboard-data { 
            background: var(--bg-card);
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-sm);
        }
        
        .data-row { 
            padding: 16px 0;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .data-row:last-child { border-bottom: none; }
        
        .data-label { 
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.9375rem;
        }
        
        .data-value { 
            color: var(--accent-primary);
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }
        
        /* Email Draft */
        .email-draft { 
            background: #f9fafb;
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 32px;
            margin-top: 24px;
        }
        
        .email-header { 
            border-bottom: 1px solid var(--border-subtle);
            padding-bottom: 20px;
            margin-bottom: 24px;
        }
        
        .email-field { 
            display: flex;
            margin-bottom: 12px;
            font-size: 0.9375rem;
        }
        
        .email-field-label { 
            font-weight: 600;
            min-width: 80px;
            color: var(--text-secondary);
        }
        
        .email-field-value { 
            color: var(--text-primary);
        }
        
        .email-body { 
            font-family: 'SF Mono', 'Monaco', monospace;
            white-space: pre-wrap;
            color: var(--text-primary);
            line-height: 1.7;
            font-size: 0.9375rem;
        }
        
        /* Genie Section */
        .genie-section { 
            background: var(--bg-card);
            padding: 24px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid var(--border-subtle);
            border-left: 3px solid var(--accent-primary);
            box-shadow: var(--shadow-sm);
        }
        
        .genie-section h3 {
            margin-bottom: 16px;
            font-weight: 600;
            font-size: 1.125rem;
            letter-spacing: -0.01em;
        }
        
        .genie-input { 
            width: 100%;
            padding: 14px 18px;
            background: #f3f4f6;
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            border-radius: 12px;
            font-size: 1rem;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }
        
        .genie-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: var(--bg-secondary);
            box-shadow: 0 0 0 3px rgba(255, 87, 51, 0.1);
        }
        
        .genie-results { 
            background: #f3f4f6;
            padding: 24px;
            border-radius: 12px;
            margin-top: 16px;
            min-height: 100px;
            display: none;
            animation: fadeIn 0.3s ease-out;
        }
        
        .genie-results.active { display: block; }
        
        .genie-results table {
            font-size: 0.875rem;
        }
        
        .genie-results th {
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* Loading & Shimmer */
        .loading { 
            text-align: center;
            padding: 48px;
            color: var(--text-secondary);
            font-size: 0.9375rem;
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 32px;
            right: 32px;
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-subtle);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .property-header { flex-direction: column; align-items: flex-start; }
            .property-actions { flex-wrap: wrap; }
            .role-selection { flex-direction: column; }
            .filter-row { flex-direction: column; align-items: flex-start; }
            .filter-label { min-width: auto; }
            .insights-grid { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 1200px) {
            .insights-grid { grid-template-columns: 1fr; }
        }
        
        /* Mobile optimizations for map */
        @media (max-width: 768px) {
            .map-card {
                height: 400px;
                padding: 16px;
            }
            
            .property-map {
                padding: 12px;
            }
            
            .map-controls {
                top: 16px;
                right: 16px;
            }
            
            .map-control-btn {
                padding: 6px 10px;
                font-size: 0.8125rem;
            }
            
            .map-control-btn span {
                display: none; /* Hide text on mobile, show icon only */
            }
            
            .map-legend {
                gap: 16px;
                font-size: 0.8125rem;
            }
            
            /* Auto-expand map to fullscreen on mobile when interacted */
            .property-map:active {
                cursor: pointer;
            }
        }
        
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            animation: fadeIn 0.2s ease;
        }
        
        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--bg-card);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
                flex-direction: column;
            animation: slideUp 0.3s ease;
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--text-secondary);
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
                justify-content: center;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: 24px;
            overflow-y: auto;
        }
        
        .modal-property-summary {
            margin-bottom: 20px;
        }
        
        .modal-property-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .modal-property-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .modal-property-status.critical {
            background: rgba(211, 47, 47, 0.1);
            color: var(--status-critical);
        }
        
        .modal-property-status.warning {
            background: rgba(249, 168, 37, 0.1);
            color: var(--status-warning);
        }
        
        .modal-issue {
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .modal-issue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .modal-issue-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .modal-issue-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .modal-issue-badge.critical {
            background: rgba(211, 47, 47, 0.1);
            color: var(--status-critical);
        }
        
        .modal-issue-badge.warning {
            background: rgba(249, 168, 37, 0.1);
            color: var(--status-warning);
        }
        
        .modal-issue-diagnosis {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 8px;
        }
        
        .modal-issue-solution {
            color: var(--accent-primary);
            font-size: 0.875rem;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">Lakehouse Inn Voice of Customer</div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <div class="persona-badge" id="persona-badge">Select Persona</div>
                <button class="action-button" id="switch-persona-btn" style="display: none; padding: 8px 16px; font-size: 0.9em;" onclick="switchPersona()">Switch Persona</button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <!-- Role Selection -->
        <div id="role-selection" class="screen active">
            <h1 class="screen-title">Welcome to Lakehouse Inn VoC Demo</h1>
            <p class="screen-subtitle">Select your persona to begin</p>
            <div class="role-selection">
                <button class="role-button" onclick="selectPersona('hq')">HQ</button>
                <button class="role-button" onclick="selectPersona('property-manager')">Property Manager</button>
                </div>
            </div>

        <!-- HQ Flow -->
        <div id="hq-flow" style="display: none;">
            <!-- HQ: Properties List -->
            <div id="hq-properties" class="screen active">
                <h1 class="screen-title">HQ: Properties Overview</h1>
                <p class="screen-subtitle">Monitor property health and identify issues at a glance</p>
                
                <!-- Data Processing Scale Banner -->
                <div class="scale-banner">
                    <div class="scale-item">
                        <div class="scale-value" id="total-reviews">--</div>
                        <div class="scale-label">Reviews Analyzed</div>
                                </div>
                    <div class="scale-divider"></div>
                    <div class="scale-item">
                        <div class="scale-value" id="total-locations">--</div>
                        <div class="scale-label">Locations Monitored</div>
                                </div>
                    <div class="scale-divider"></div>
                    <div class="scale-item">
                        <div class="scale-value" id="date-range">--</div>
                        <div class="scale-label">Date Range</div>
                    </div>
                    <div class="scale-divider"></div>
                    <div class="scale-item">
                        <div class="scale-value" id="data-points">--</div>
                        <div class="scale-label">Data Points Processed</div>
                            </div>
                        </div>

                <!-- Summary Dashboard Cards -->
                <div class="summary-grid">
                    <!-- Key Metrics -->
                    <div class="summary-card metric-card">
                        <div class="metric-icon-box default">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <rect x="3" y="14" width="7" height="7"></rect>
                            </svg>
                                </div>
                        <div class="metric-content">
                            <div class="metric-label">Total Properties</div>
                            <div class="metric-value" id="total-properties">--</div>
                                </div>
                                </div>

                    <div class="summary-card metric-card critical-metric">
                        <div class="metric-icon-box critical">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                            </svg>
                                </div>
                        <div class="metric-content">
                            <div class="metric-label">Critical Issues</div>
                            <div class="metric-value" id="critical-count">--</div>
                            <div class="metric-change negative" id="critical-change">--</div>
                            </div>
                        </div>

                    <div class="summary-card metric-card warning-metric">
                        <div class="metric-icon-box warning">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                <line x1="12" y1="9" x2="12" y2="13"></line>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                                </div>
                        <div class="metric-content">
                            <div class="metric-label">Warnings</div>
                            <div class="metric-value" id="warning-count">--</div>
                            <div class="metric-change" id="warning-change">--</div>
                                </div>
                                </div>

                    <div class="summary-card metric-card healthy-metric">
                        <div class="metric-icon-box healthy">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </div>
                        <div class="metric-content">
                            <div class="metric-label">Healthy Properties</div>
                            <div class="metric-value" id="healthy-count">--</div>
                            <div class="metric-change positive" id="healthy-change">--</div>
                                </div>
                            </div>
                        </div>

                <!-- Map & Insights -->
                <div class="insights-grid">
                    <!-- Property Map -->
                    <div class="summary-card map-card">
                        <div class="insights-header">
                            <h3>Property Locations</h3>
                            <span class="insights-subtitle">Geographic distribution and status</span>
                                </div>
                <div id="property-map" class="property-map">
                    <!-- Map Controls -->
                    <div class="map-controls">
                        <button class="map-control-btn" onclick="toggleMapFullscreen()" id="fullscreen-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                            </svg>
                            <span id="fullscreen-text">Expand</span>
                        </button>
                        </div>

                    <svg viewBox="0 0 960 600" preserveAspectRatio="xMidYMid meet" style="width: 100%; height: 100%;">
                        <!-- Glow effect for critical/warning dots -->
                        <defs>
                            <filter id="glow-critical">
                                <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                                <feMerge>
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                            <filter id="glow-warning">
                                <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                                <feMerge>
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                        
                        <!-- Background -->
                        <rect width="960" height="600" fill="#fafafa"/>
                        
                        <!-- Simplified US Map - Rectangular approach with state boundaries -->
                        <g id="us-map-outline" fill="white" stroke="#c0c0c0" stroke-width="2">
                            <!-- West Coast States -->
                            <rect x="50" y="100" width="100" height="350" fill="#f8f8f8" stroke="#d0d0d0" stroke-width="1.5"/>
                            
                            <!-- Mountain/Plains States -->
                            <rect x="150" y="150" width="150" height="300" fill="#f8f8f8" stroke="#d0d0d0" stroke-width="1.5"/>
                            
                            <!-- Central States -->
                            <rect x="300" y="180" width="200" height="270" fill="#f8f8f8" stroke="#d0d0d0" stroke-width="1.5"/>
                            
                            <!-- Great Lakes/Midwest -->
                            <rect x="500" y="150" width="150" height="250" fill="#f8f8f8" stroke="#d0d0d0" stroke-width="1.5"/>
                            
                            <!-- Northeast -->
                            <rect x="650" y="100" width="200" height="200" fill="#f8f8f8" stroke="#d0d0d0" stroke-width="1.5"/>
                            
                            <!-- Southeast -->
                            <rect x="550" y="300" width="300" height="180" fill="#f8f8f8" stroke="#d0d0d0" stroke-width="1.5"/>
                            
                            <!-- Outer border -->
                            <rect x="50" y="100" width="800" height="380" fill="none" stroke="#888" stroke-width="3"/>
                            
                            <!-- Internal grid lines for states -->
                            <line x1="150" y1="100" x2="150" y2="480" stroke="#d0d0d0" stroke-width="1.5"/>
                            <line x1="300" y1="100" x2="300" y2="480" stroke="#d0d0d0" stroke-width="1.5"/>
                            <line x1="500" y1="100" x2="500" y2="480" stroke="#d0d0d0" stroke-width="1.5"/>
                            <line x1="650" y1="100" x2="650" y2="480" stroke="#d0d0d0" stroke-width="1.5"/>
                            
                            <line x1="50" y1="200" x2="850" y2="200" stroke="#e5e5e5" stroke-width="1"/>
                            <line x1="50" y1="300" x2="850" y2="300" stroke="#e5e5e5" stroke-width="1"/>
                            <line x1="50" y1="400" x2="850" y2="400" stroke="#e5e5e5" stroke-width="1"/>
                            
                            <!-- Region labels -->
                            <text x="100" y="130" text-anchor="middle" fill="#999" font-size="11" font-weight="600">WEST</text>
                            <text x="225" y="180" text-anchor="middle" fill="#999" font-size="11" font-weight="600">MOUNTAIN</text>
                            <text x="400" y="210" text-anchor="middle" fill="#999" font-size="11" font-weight="600">CENTRAL</text>
                            <text x="575" y="180" text-anchor="middle" fill="#999" font-size="11" font-weight="600">MIDWEST</text>
                            <text x="750" y="130" text-anchor="middle" fill="#999" font-size="11" font-weight="600">NORTHEAST</text>
                            <text x="700" y="330" text-anchor="middle" fill="#999" font-size="11" font-weight="600">SOUTHEAST</text>
                        </g>
                        
                        <!-- Property markers will be added here dynamically -->
                        <g id="property-markers"></g>
                    </svg>
                    
                    <!-- Tooltip container -->
                    <div id="map-tooltip" class="map-tooltip"></div>
                            <div class="map-legend">
                                <div class="legend-item">
                                    <div class="legend-dot critical"></div>
                                    <span>Critical Issues</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-dot warning"></div>
                                    <span>Warnings</span>
                        </div>
                                <div class="legend-item">
                                    <div class="legend-dot healthy"></div>
                                    <span>Healthy</span>
                            </div>
                        </div>
                    </div>
                </div>

                    <!-- Top Issues & Properties -->
                    <div class="summary-card insights-card tall-card">
                        <div class="insights-header">
                            <h3>Top Issues</h3>
                            <span class="insights-subtitle">Most critical aspects across properties</span>
                        </div>
                        <div id="top-issues" class="insights-list">
                            <div class="loading">Loading...</div>
                        </div>

                        <div class="insights-header" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-subtle);">
                            <h3>Properties Needing Attention</h3>
                            <span class="insights-subtitle">Highest priority locations</span>
                        </div>
                        <div id="top-properties" class="insights-list">
                            <div class="loading">Loading...</div>
                        </div>
                        </div>
                    </div>

                <!-- All Properties List -->
                <div class="section-divider">
                    <h2>All Properties</h2>
                    </div>

                <div id="properties-container">
                    <div class="loading">Loading properties...</div>
                    </div>
                </div>

            <!-- HQ: Property Dashboard -->
            <div id="hq-dashboard" class="screen">
                <h1 class="screen-title">Property Health Dashboard</h1>
                <p class="screen-subtitle">Validate issues and review corresponding data</p>
                
                <div class="dashboard-filter">
                    <div class="filter-row">
                        <span class="filter-label">Location:</span>
                        <input type="text" class="filter-input" id="filter-location" readonly>
            </div>
                    <div class="filter-row">
                        <span class="filter-label">Topic:</span>
                        <select class="filter-input" id="filter-topic">
                            <option value="">All Topics</option>
                            <option value="cleanliness">Cleanliness</option>
                            <option value="wifi">WiFi Connectivity</option>
                            <option value="noise">Noise Levels</option>
                            <option value="staff">Staff Service</option>
                            <option value="amenities">Amenities</option>
                        </select>
                </div>
                    <button class="action-button" onclick="applyFilters()">Apply Filter</button>
                    <button class="action-button secondary" onclick="showAllProperties()">View All Properties in Filter</button>
        </div>

                <div class="dashboard-data" id="dashboard-data">
                    <div class="loading">Select filters to view data</div>
        </div>

                <!-- HQ Genie Section -->
                <div class="genie-section">
                    <h3>Ask Genie Questions About This Property</h3>
                    <input type="text" class="genie-input" id="hq-genie-input" placeholder="Ask Genie about trends, issues, or comparisons...">
                    <button class="action-button" onclick="askGenieHQ()">Ask Genie</button>
                    <div class="genie-results" id="hq-genie-results">
                        <!-- Genie responses appear here -->
                </div>
                </div>

                <button class="action-button" onclick="backToProperties()">Back to Properties</button>
                <button class="action-button" onclick="proceedToEmail()">Proceed to Send Email</button>
            </div>

            <!-- HQ: Email Draft -->
            <div id="hq-email" class="screen">
                <h1 class="screen-title">Draft Email to Property Manager</h1>
                <p class="screen-subtitle">Review and send the pre-populated email</p>
                
                <div class="email-draft" id="email-content">
                    <div class="loading">Generating email...</div>
            </div>

                <button class="action-button" onclick="sendEmail()">Send Email</button>
                <button class="action-button secondary" onclick="backToDashboard()">Back to Dashboard</button>
            </div>
        </div>

        <!-- Property Manager Flow -->
        <div id="pm-flow" style="display: none;">
            <!-- PM: Dashboard -->
            <div id="pm-dashboard" class="screen active">
                <h1 class="screen-title">Property Manager Dashboard</h1>
                <p class="screen-subtitle">Investigate issues for your assigned property</p>
                
                <div class="dashboard-filter">
                    <div class="filter-row">
                        <span class="filter-label">My Property:</span>
                        <select class="filter-input" id="pm-property">
                            <option value="">Select Property</option>
                </select>
                    </div>
                    <button class="action-button" onclick="loadPMProperty()">Load Property Data</button>
            </div>

                <div class="dashboard-data" id="pm-dashboard-data">
                    <div class="loading">Select your property to view details</div>
                </div>

                <div class="genie-section">
                    <h3>Ask Genie for Follow-up Questions</h3>
                    <input type="text" class="genie-input" id="pm-genie-input" placeholder="Ask a follow-up question about your property...">
                    <button class="action-button" onclick="askGenieFollowup()">Ask Genie</button>
                    <div class="genie-results" id="pm-genie-results">
                        <!-- Genie responses appear here -->
                    </div>
                </div>
                    </div>
                </div>
            </div>

    <!-- Property Issue Modal -->
    <div id="property-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Property Details</h3>
                <button class="modal-close" onclick="closePropertyModal()">&times;</button>
            </div>
            <div id="modal-body" class="modal-body">
                <!-- Content will be dynamically inserted -->
            </div>
        </div>
    </div>

    <script>
        let currentPersona = '';
        let selectedProperty = null;
        let allProperties = [];
        let flaggedProperties = [];

        function selectPersona(persona) {
            currentPersona = persona;
            document.getElementById('role-selection').style.display = 'none';
            document.getElementById('persona-badge').textContent = persona === 'hq' ? 'HQ Persona' : 'Property Manager';
            document.getElementById('switch-persona-btn').style.display = 'inline-block';
            
            // Hide both flows first
            document.getElementById('hq-flow').style.display = 'none';
            document.getElementById('pm-flow').style.display = 'none';
            
            if (persona === 'hq') {
                document.getElementById('hq-flow').style.display = 'block';
                document.querySelectorAll('#hq-flow .screen').forEach(s => s.classList.remove('active'));
                document.getElementById('hq-properties').classList.add('active');
                loadHQProperties();
            } else {
                document.getElementById('pm-flow').style.display = 'block';
                document.querySelectorAll('#pm-flow .screen').forEach(s => s.classList.remove('active'));
                document.getElementById('pm-dashboard').classList.add('active');
                loadPMProperties();
            }
        }

        function switchPersona() {
            const newPersona = currentPersona === 'hq' ? 'property-manager' : 'hq';
            selectPersona(newPersona);
        }

        // ========================================
        // HQ SUMMARY DASHBOARD
        // ========================================
        
        async function loadHQProperties() {
            try {
                const [propsResponse, flaggedResponse] = await Promise.all([
                    fetch('/api/properties'),
                    fetch('/api/diagnostics/flagged-properties')
                ]);
                
                const propsData = await propsResponse.json();
                const flaggedData = await flaggedResponse.json();
                
                allProperties = propsData.properties || [];
                flaggedProperties = flaggedData.flagged_properties || [];
                
                // Update scale banner (data processing stats)
                updateScaleBanner();
                
                // Update summary metrics
                updateSummaryMetrics();
                
                // Update insights
                updateTopIssues();
                updateTopProperties();
                
                // Render property map
                renderPropertyMap();
                
                // Render properties list
                renderPropertiesGrouped();
            } catch (error) {
                document.getElementById('properties-container').innerHTML = '<p style="color: #dc3545;">Failed to load properties.</p>';
            }
        }
        
        function updateScaleBanner() {
            // Calculate total reviews from flagged properties data
            // In a real scenario, this would come from an API endpoint
            const totalReviews = flaggedProperties.length > 0 
                ? Math.floor(flaggedProperties.length * 87.3) // Simulate based on data
                : 12847;
            
            // Format large numbers with commas
            const formatNumber = (num) => num.toLocaleString('en-US');
            
            // Calculate data points (reviews × aspects analyzed)
            const aspectsAnalyzed = 8; // WiFi, Cleanliness, Staff, Location, etc.
            const dataPoints = totalReviews * aspectsAnalyzed;
            
            // Get date range (last 90 days for demo)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 90);
            
            const formatDate = (date) => {
                const month = date.toLocaleString('en-US', { month: 'short' });
                const year = date.getFullYear();
                return `${month} ${year}`;
            };
            
            const dateRange = `${formatDate(startDate)} - ${formatDate(endDate)}`;
            
            // Update DOM
            document.getElementById('total-reviews').textContent = formatNumber(totalReviews);
            document.getElementById('total-locations').textContent = allProperties.length || '--';
            document.getElementById('date-range').textContent = dateRange;
            document.getElementById('data-points').textContent = formatNumber(dataPoints);
        }
        
        function updateSummaryMetrics() {
            // Calculate metrics
            const critical = [];
            const warning = [];
            const healthy = [];
            
            allProperties.forEach(prop => {
                const issues = flaggedProperties.filter(f => f.property_id === prop.id);
                if (issues.some(i => i.status === 'critical')) {
                    critical.push(prop);
                } else if (issues.length > 0) {
                    warning.push(prop);
                } else {
                    healthy.push(prop);
                }
            });
            
            // Update DOM
            document.getElementById('total-properties').textContent = allProperties.length;
            document.getElementById('critical-count').textContent = critical.length;
            document.getElementById('warning-count').textContent = warning.length;
            document.getElementById('healthy-count').textContent = healthy.length;
            
            // Update change indicators (mock percentages for demo)
            const criticalChange = critical.length > 0 ? `${critical.length} properties` : 'None';
            const warningChange = warning.length > 0 ? `${warning.length} properties` : 'None';
            const healthyChange = `${Math.round((healthy.length / allProperties.length) * 100)}% of total`;
            
            document.getElementById('critical-change').textContent = criticalChange;
            document.getElementById('warning-change').textContent = warningChange;
            document.getElementById('healthy-change').textContent = healthyChange;
        }
        
        function updateTopIssues() {
            // Aggregate issues by aspect across all properties
            const issueMap = {};
            
            flaggedProperties.forEach(issue => {
                if (!issueMap[issue.aspect]) {
                    issueMap[issue.aspect] = {
                        aspect: issue.aspect,
                        count: 0,
                        totalPercentage: 0,
                        properties: []
                    };
                }
                issueMap[issue.aspect].count++;
                issueMap[issue.aspect].totalPercentage += parseFloat(issue.negative_percentage) || 0;
                issueMap[issue.aspect].properties.push(issue.property);
            });
            
            // Convert to array and sort by count
            const topIssues = Object.values(issueMap)
                .sort((a, b) => b.count - a.count)
                .slice(0, 5);
            
            const container = document.getElementById('top-issues');
            if (topIssues.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No issues detected</div>';
                return;
            }
            
            container.innerHTML = topIssues.map(issue => {
                const avgPercentage = (issue.totalPercentage / issue.count).toFixed(1);
                const severity = avgPercentage > 5 ? 'critical' : 'warning';
                return `
                    <div class="insight-item">
                        <div class="insight-content">
                            <div class="insight-title">${issue.aspect}</div>
                            <div class="insight-subtitle">${issue.count} properties affected · Avg ${avgPercentage}% negative</div>
                        </div>
                        <div class="insight-badge ${severity}">${issue.count} properties</div>
                    </div>
                `;
            }).join('');
        }
        
        function renderPropertyMap() {
            // ========================================
            // DATABRICKS POINT MAP PATTERN
            // ========================================
            // Following https://docs.databricks.com/aws/en/dashboards/visualizations/types#point-map
            // 
            // In production, this data would come from your Delta table with:
            // - LATITUDE column (decimal degrees, e.g., 41.8781 for Chicago)
            // - LONGITUDE column (decimal degrees, e.g., -87.6298 for Chicago)
            // - Quantitative fields for color/size encoding (e.g., avg(bedrooms), sum(price))
            //
            // Example SQL:
            // SELECT 
            //   location,
            //   AVG(latitude) as LATITUDE,
            //   AVG(longitude) as LONGITUDE,
            //   COUNT(*) as issue_count,
            //   AVG(neg_share_7d) as avg_negative_share
            // FROM dan_morris.lakehouse_inn_voc.raw_loc_aspect_daily
            // GROUP BY location
            // ========================================
            
            // Property location coordinates with real lat/lon (converted to SVG coordinates)
            const cityCoordinates = {
                // West Coast - Latitude: ~47-37°N, Longitude: ~-122 to -121°W
                'seattle-wa': { 
                    x: 100, y: 150, name: 'Seattle, WA',
                    lat: 47.6062, lon: -122.3321 
                },
                'portland-or': { 
                    x: 100, y: 180, name: 'Portland, OR',
                    lat: 45.5152, lon: -122.6784
                },
                'san-jose-ca': { 
                    x: 90, y: 280, name: 'San Jose, CA',
                    lat: 37.3382, lon: -121.8863
                },
                
                // Mountain/Southwest - Latitude: ~33-40°N, Longitude: ~-115 to -105°W
                'denver-downtown': { 
                    x: 225, y: 250, name: 'Denver, CO',
                    lat: 39.7392, lon: -104.9903
                },
                'phoenix-az': { 
                    x: 200, y: 350, name: 'Phoenix, AZ',
                    lat: 33.4484, lon: -112.0740
                },
                'las-vegas-nv': { 
                    x: 170, y: 300, name: 'Las Vegas, NV',
                    lat: 36.1699, lon: -115.1398
                },
                
                // Central - Latitude: ~30-33°N, Longitude: ~-98 to -97°W
                'dallas-tx': { 
                    x: 400, y: 380, name: 'Dallas, TX',
                    lat: 32.7767, lon: -96.7970
                },
                'austin-tx': { 
                    x: 380, y: 410, name: 'Austin, TX',
                    lat: 30.2672, lon: -97.7431
                },
                
                // Midwest/Great Lakes - Latitude: ~41-42°N, Longitude: ~-88 to -87°W
                'chicago-loop': { 
                    x: 560, y: 220, name: 'Chicago, IL',
                    lat: 41.8781, lon: -87.6298
                },
                'chicago-ohare': { 
                    x: 550, y: 210, name: 'Chicago O\'Hare, IL',
                    lat: 41.9742, lon: -87.9073
                },
                
                // Northeast - Latitude: ~40-42°N, Longitude: ~-74 to -71°W
                'boston-ma': { 
                    x: 800, y: 150, name: 'Boston, MA',
                    lat: 42.3601, lon: -71.0589
                },
                'newark-nj': { 
                    x: 780, y: 180, name: 'Newark, NJ',
                    lat: 40.7357, lon: -74.1724
                },
                
                // Southeast - Latitude: ~25-34°N, Longitude: ~-84 to -80°W
                'atlanta-ga': { 
                    x: 650, y: 350, name: 'Atlanta, GA',
                    lat: 33.7490, lon: -84.3880
                },
                'tampa-fl': { 
                    x: 730, y: 420, name: 'Tampa, FL',
                    lat: 27.9506, lon: -82.4572
                },
                'miami-fl': { 
                    x: 750, y: 450, name: 'Miami, FL',
                    lat: 25.7617, lon: -80.1918
                },
                
                // Add fallback for locations without specific coordinates
                'default': { 
                    x: 450, y: 290, name: 'Unknown Location',
                    lat: 39.8283, lon: -98.5795 // Geographic center of USA
                }
            };
            
            const markersGroup = document.getElementById('property-markers');
            const tooltip = document.getElementById('map-tooltip');
            
            if (!markersGroup) {
                console.error('Property markers group not found');
                return;
            }
            
            markersGroup.innerHTML = ''; // Clear existing markers
            
            console.log('Rendering map with properties:', allProperties.length);
            
            // Calculate status for each property
            const propertyStatuses = allProperties.map(prop => {
                const issues = flaggedProperties.filter(f => f.property_id === prop.id);
                const hasCritical = issues.some(i => i.status === 'critical');
                const hasWarning = issues.length > 0;
                
                return {
                    ...prop,
                    status: hasCritical ? 'critical' : (hasWarning ? 'warning' : 'healthy'),
                    issueCount: issues.length
                };
            });
            
            // Render each property as a dot on the map
            propertyStatuses.forEach(prop => {
                const coords = cityCoordinates[prop.id] || cityCoordinates[prop.id.toLowerCase()] || cityCoordinates['default'];
                console.log('Property:', prop.id, 'Coords:', coords, 'Status:', prop.status);
                
                // Create marker circle (following Databricks point map pattern)
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', coords.x);
                circle.setAttribute('cy', coords.y);
                
                // Size based on issue count (like Databricks size encoding)
                const markerSize = prop.issueCount > 0 ? 8 + (prop.issueCount * 2) : 8;
                circle.setAttribute('r', markerSize);
                
                circle.setAttribute('class', `map-marker ${prop.status}`);
                
                // Store metadata as data attributes
                circle.setAttribute('data-property', prop.id);
                circle.setAttribute('data-name', coords.name);
                circle.setAttribute('data-issues', prop.issueCount);
                circle.setAttribute('data-lat', coords.lat);
                circle.setAttribute('data-lon', coords.lon);
                circle.setAttribute('data-status', prop.status);
                
                // Add hover effect with tooltip (using dedicated tooltip element)
                circle.addEventListener('mouseenter', function(e) {
                    if (tooltip) {
                        // Enhanced tooltip with multiple data points (like Databricks)
                        const statusLabel = prop.status === 'critical' ? '🔴 Critical' : 
                                          prop.status === 'warning' ? '🟡 Warning' : 
                                          '🟢 Healthy';
                        tooltip.innerHTML = `
                            <div style="font-weight: 600; margin-bottom: 4px;">${coords.name}</div>
                            <div style="font-size: 0.8125rem;">
                                <div>Status: ${statusLabel}</div>
                                <div>Issues: ${prop.issueCount}</div>
                                <div style="font-size: 0.75rem; color: #ccc; margin-top: 2px;">
                                    ${coords.lat.toFixed(4)}°N, ${Math.abs(coords.lon).toFixed(4)}°W
                                </div>
                            </div>
                        `;
                        tooltip.style.opacity = '1';
                        tooltip.style.pointerEvents = 'none'; // Prevent tooltip from interfering with mouse
                    }
                });
                
                circle.addEventListener('mouseleave', function() {
                    if (tooltip) {
                        tooltip.style.opacity = '0';
                    }
                });
                
                circle.addEventListener('mousemove', function(e) {
                    if (tooltip) {
                        tooltip.style.left = (e.clientX + 10) + 'px';
                        tooltip.style.top = (e.clientY - 30) + 'px';
                    }
                });
                
                // Click to show property modal
                circle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    showPropertyModal(prop.id);
                });
                
                markersGroup.appendChild(circle);
            });
        }
        
        // ========================================
        // PROPERTY MODAL FUNCTIONS
        // ========================================
        
        function showPropertyModal(propertyId) {
            const property = allProperties.find(p => p.id === propertyId);
            if (!property) return;
            
            const issues = flaggedProperties.filter(f => f.property_id === propertyId);
            const hasCritical = issues.some(i => i.status === 'critical');
            const status = hasCritical ? 'critical' : (issues.length > 0 ? 'warning' : 'healthy');
            
            // Update modal title
            document.getElementById('modal-title').textContent = property.name;
            
            // Build modal content
            let content = `
                <div class="modal-property-summary">
                    <div class="modal-property-name">${property.name}</div>
                    <div class="modal-property-status ${status}">${issues.length} issue(s) detected</div>
                </div>
            `;
            
            if (issues.length === 0) {
                content += `<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No issues detected at this property. All systems healthy.</div>`;
            } else {
                content += `<div style="margin-bottom: 12px;"><strong>Issues Requiring Attention:</strong></div>`;
                issues.forEach(issue => {
                    content += `
                        <div class="modal-issue">
                            <div class="modal-issue-header">
                                <div class="modal-issue-name">${issue.aspect}</div>
                                <div class="modal-issue-badge ${issue.status}">${issue.status}</div>
                            </div>
                            <div class="modal-issue-diagnosis">
                                Diagnosis: ${issue.negative_percentage}% negative feedback (7-day average)
                            </div>
                            <div class="modal-issue-solution">
                                Prescribed Solution: Immediate attention required - review guest feedback and implement corrective actions
                            </div>
                        </div>
                    `;
                });
            }
            
            // Add action button
            content += `
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-subtle);">
                    <button class="action-button" onclick="closePropertyModal(); viewDashboard('${propertyId}');">
                        View Full Property Dashboard
                    </button>
                </div>
            `;
            
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('property-modal').classList.add('active');
        }
        
        function closePropertyModal() {
            document.getElementById('property-modal').classList.remove('active');
        }
        
        // Close modal on outside click
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('property-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closePropertyModal();
                }
            });
        });
        
        // ========================================
        // MAP FULLSCREEN CONTROLS
        // ========================================
        
        function toggleMapFullscreen() {
            const mapContainer = document.getElementById('property-map');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const fullscreenText = document.getElementById('fullscreen-text');
            
            if (!mapContainer) return;
            
            if (mapContainer.classList.contains('fullscreen')) {
                // Exit fullscreen
                mapContainer.classList.remove('fullscreen');
                fullscreenText.textContent = 'Expand';
                document.body.style.overflow = ''; // Restore scrolling
                    } else {
                // Enter fullscreen
                mapContainer.classList.add('fullscreen');
                fullscreenText.textContent = 'Exit';
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            }
        }
        
        // ESC key to exit fullscreen
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const mapContainer = document.getElementById('property-map');
                if (mapContainer && mapContainer.classList.contains('fullscreen')) {
                    toggleMapFullscreen();
                }
            }
        });
        
        function updateTopProperties() {
            // Sort properties by number of critical issues
            const propertiesWithIssues = allProperties.map(prop => {
                const issues = flaggedProperties.filter(f => f.property_id === prop.id);
                const criticalIssues = issues.filter(i => i.status === 'critical');
                return {
                    ...prop,
                    issues,
                    criticalCount: criticalIssues.length,
                    totalIssues: issues.length
                };
            }).filter(p => p.totalIssues > 0)
              .sort((a, b) => b.criticalCount - a.criticalCount || b.totalIssues - a.totalIssues)
              .slice(0, 5);
            
            const container = document.getElementById('top-properties');
            if (propertiesWithIssues.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">All properties healthy</div>';
                return;
            }
            
            container.innerHTML = propertiesWithIssues.map(prop => {
                const severity = prop.criticalCount > 0 ? 'critical' : 'warning';
                const label = prop.criticalCount > 0 
                    ? `${prop.criticalCount} critical` 
                    : `${prop.totalIssues} issues`;
                return `
                    <div class="insight-item" onclick="viewDashboard('${prop.id}')">
                        <div class="insight-content">
                            <div class="insight-title">${prop.name}</div>
                            <div class="insight-subtitle">${prop.totalIssues} total issues requiring attention</div>
                        </div>
                        <div class="insight-badge ${severity}">${label}</div>
                    </div>
                `;
            }).join('');
        }

        function renderPropertiesGrouped() {
            const container = document.getElementById('properties-container');
            const critical = [];
            const warning = [];
            const good = [];
            
            allProperties.forEach(prop => {
                const issues = flaggedProperties.filter(f => f.property_id === prop.id);
                if (issues.some(i => i.status === 'critical')) {
                    critical.push({ ...prop, issues });
                } else if (issues.length > 0) {
                    warning.push({ ...prop, issues });
            } else {
                    good.push({ ...prop, issues: [] });
                }
            });
            
            container.innerHTML = '';
            
            if (critical.length > 0) {
                container.innerHTML += `<div class="property-group"><div class="group-header group-critical">Critical Issues (${critical.length})</div>`;
                critical.forEach(prop => container.innerHTML += renderPropertyRow(prop));
                container.innerHTML += '</div>';
            }
            
            if (warning.length > 0) {
                container.innerHTML += `<div class="property-group"><div class="group-header group-warning">Warnings (${warning.length})</div>`;
                warning.forEach(prop => container.innerHTML += renderPropertyRow(prop));
                container.innerHTML += '</div>';
            }
            
            if (good.length > 0) {
                container.innerHTML += `<div class="property-group"><div class="group-header group-good">Healthy Properties (${good.length})</div>`;
                good.forEach(prop => container.innerHTML += renderPropertyRow(prop));
                container.innerHTML += '</div>';
            }
        }

        function renderPropertyRow(prop) {
            const hasCritical = prop.issues.some(i => i.status === 'critical');
            const hasIssues = prop.issues.length > 0;
            return `
                <div class="property-row" id="prop-${prop.id}">
                    <div class="property-header" onclick="toggleProperty('${prop.id}')">
                        <div>
                            <div class="property-name">${prop.name}</div>
                            <div class="property-summary">${prop.issues.length} issue(s) identified</div>
                        </div>
                    </div>
                    <div class="property-actions">
                        <button class="action-button" onclick="event.stopPropagation(); viewDashboard('${prop.id}')">View Property Dashboard</button>
                        ${hasIssues ? `<button class="action-button secondary" onclick="event.stopPropagation(); viewDraftEmail('${prop.id}')">View Draft Emails</button>` : ''}
                    </div>
                    <div class="property-details" id="details-${prop.id}">
                        <div>
                            ${prop.issues.map(issue => `
                                <div class="check-item ${issue.status}">
                                    <div class="check-header">
                                        <span class="check-name">${issue.aspect}</span>
                                        <span class="check-status status-${issue.status}">${issue.status.toUpperCase()}</span>
                                    </div>
                                    <div class="check-diagnosis">Diagnosis: ${issue.negative_percentage}% negative feedback (7-day average)</div>
                                    <div class="check-solution">Prescribed Solution: Immediate attention required - review guest feedback and implement corrective actions</div>
                                </div>
                            `).join('')}
                            ${prop.issues.length === 0 ? '<div class="check-item green"><div class="check-header"><span class="check-name">All Checks Passed</span><span class="check-status status-green">HEALTHY</span></div></div>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleProperty(id) {
            const row = document.getElementById(`prop-${id}`);
            const details = document.getElementById(`details-${id}`);
            row.classList.toggle('expanded');
            details.classList.toggle('active');
        }

        function viewDashboard(id) {
            selectedProperty = allProperties.find(p => p.id === id);
            document.getElementById('filter-location').value = selectedProperty.name;
            document.querySelectorAll('#hq-flow .screen').forEach(s => s.classList.remove('active'));
            document.getElementById('hq-dashboard').classList.add('active');
            applyFilters();
        }

        async function applyFilters() {
            const location = document.getElementById('filter-location').value;
            const topic = document.getElementById('filter-topic').value;
            
            try {
                const response = await fetch(`/api/properties/${selectedProperty.id}/details`);
                const data = await response.json();
                
                let filteredAspects = data.aspects || [];
                if (topic) {
                    filteredAspects = filteredAspects.filter(a => a.name.toLowerCase().includes(topic));
                }
                
                const dataContainer = document.getElementById('dashboard-data');
                dataContainer.innerHTML = `
                    <h3>${location}</h3>
                    <div class="data-row"><span class="data-label">Total Reviews:</span><span class="data-value">${data.reviews_count || 0}</span></div>
                    <div class="data-row"><span class="data-label">Avg Rating:</span><span class="data-value">${data.avg_rating || 'N/A'}/5.0</span></div>
                    <h4 style="margin-top: 20px;">Issues by Aspect:</h4>
                    ${filteredAspects.map(aspect => `
                        <div class="data-row">
                            <span class="data-label">${aspect.name}:</span>
                            <span class="data-value">${aspect.percentage}% negative (${aspect.status})</span>
                        </div>
                    `).join('')}
                `;
                } catch (error) {
                document.getElementById('dashboard-data').innerHTML = '<p style="color: #dc3545;">Failed to load data.</p>';
            }
        }

        function showAllProperties() {
            alert('Showing all properties in current filter. In full implementation, this would display a comprehensive list of properties matching the selected topic/criteria.');
        }

        function backToProperties() {
            document.querySelectorAll('#hq-flow .screen').forEach(s => s.classList.remove('active'));
            document.getElementById('hq-properties').classList.add('active');
        }

        function proceedToEmail() {
            document.querySelectorAll('#hq-flow .screen').forEach(s => s.classList.remove('active'));
            document.getElementById('hq-email').classList.add('active');
            generateEmailDraft();
        }

        async function generateEmailDraft() {
            try {
                const response = await fetch(`/api/properties/${selectedProperty.id}/generate-email`, { method: 'POST' });
                const data = await response.json();
                
                document.getElementById('email-content').innerHTML = `
                    <div class="email-header">
                        <div class="email-field">
                            <span class="email-field-label">To:</span>
                            <span class="email-field-value">Property Manager - ${selectedProperty.name}</span>
                        </div>
                        <div class="email-field">
                            <span class="email-field-label">From:</span>
                            <span class="email-field-value">Lakehouse Inn HQ</span>
                        </div>
                        <div class="email-field">
                            <span class="email-field-label">Subject:</span>
                            <span class="email-field-value">Action Required: Guest Feedback Issues</span>
                        </div>
                    </div>
                    <div class="email-body">${data.email_content}</div>
                    <p style="margin-top: 20px; color: #b8b8b8; font-style: italic;">Note: Links in this email will direct the property manager to the same dashboard, filtered to their property.</p>
                `;
                } catch (error) {
                document.getElementById('email-content').innerHTML = '<p style="color: #dc3545;">Failed to generate email.</p>';
            }
        }

        function sendEmail() {
            alert('Email sent to Property Manager!\n\nNext: Switching to Property Manager perspective to show how they receive and investigate the issue.');
            setTimeout(() => {
                selectPersona('property-manager');
            }, 1500);
        }

        function backToDashboard() {
            document.querySelectorAll('#hq-flow .screen').forEach(s => s.classList.remove('active'));
            document.getElementById('hq-dashboard').classList.add('active');
        }

        function viewDraftEmail(id) {
            selectedProperty = allProperties.find(p => p.id === id);
            proceedToEmail();
        }

        async function loadPMProperties() {
            try {
                const response = await fetch('/api/properties');
                const data = await response.json();
                const select = document.getElementById('pm-property');
                select.innerHTML = '<option value="">Select Property</option>';
                (data.properties || []).forEach(prop => {
                    select.innerHTML += `<option value="${prop.id}">${prop.name}</option>`;
                });
                } catch (error) {
                console.error('Failed to load properties for PM');
            }
        }

        async function loadPMProperty() {
            const propId = document.getElementById('pm-property').value;
            if (!propId) return;
            
            try {
                const response = await fetch(`/api/properties/${propId}/details`);
                const data = await response.json();
                
                const dataContainer = document.getElementById('pm-dashboard-data');
                dataContainer.innerHTML = `
                    <h3>My Property: ${data.name}</h3>
                    <div class="data-row"><span class="data-label">Total Reviews:</span><span class="data-value">${data.reviews_count || 0}</span></div>
                    <div class="data-row"><span class="data-label">Avg Rating:</span><span class="data-value">${data.avg_rating || 'N/A'}/5.0</span></div>
                    <h4 style="margin-top: 20px;">Issues Requiring Attention:</h4>
                    ${(data.aspects || []).map(aspect => `
                        <div class="data-row">
                            <span class="data-label">${aspect.name}:</span>
                            <span class="data-value">${aspect.percentage}% negative (${aspect.status})</span>
                                        </div>
                    `).join('')}
                    <p style="margin-top: 20px; color: #b8b8b8;">Review the details above and use Genie below to ask follow-up questions.</p>
                `;
                } catch (error) {
                document.getElementById('pm-dashboard-data').innerHTML = '<p style="color: #dc3545;">Failed to load property data.</p>';
            }
        }

        // ========================================
        // GENIE FUNCTIONS - Shared query logic for both HQ and Property Manager
        // ========================================
        
        async function askGenie(inputId, resultsId) {
            const query = document.getElementById(inputId).value;
            if (!query.trim()) {
                alert('Please enter a question for Genie.');
                        return;
                    }
                    
            const resultsDiv = document.getElementById(resultsId);
            resultsDiv.innerHTML = '<div class="loading">Querying Genie...</div>';
            resultsDiv.classList.add('active');
            
            try {
                const response = await fetch('/api/dashboard/genie-query', {
                            method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                const data = await response.json();
                
                if (data.error) {
                    resultsDiv.innerHTML = `<p style="color: var(--status-critical);">Error: ${data.error}</p>`;
                } else if (data.results && data.results.length > 0) {
                    resultsDiv.innerHTML = data.results.map(result => {
                        if (result.type === 'text') {
                            return `<p style="line-height: 1.6; color: var(--text-primary);">${result.content}</p>`;
                        } else if (result.type === 'table') {
                            return `
                                <h4 style="color: var(--text-primary); margin-bottom: 12px;">${result.description || 'Query Results'}</h4>
                                <table style="width: 100%; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 8px; overflow: hidden;">
                                    <thead>
                                        <tr style="background: var(--accent-primary); color: white;">
                                            ${(result.columns || []).map(col => `<th style="padding: 12px; text-align: left; font-weight: 500;">${col}</th>`).join('')}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${(result.data || []).map(row => `<tr style="border-bottom: 1px solid var(--border-subtle);">${Object.values(row).map(val => `<td style="padding: 12px; color: var(--text-primary);">${val}</td>`).join('')}</tr>`).join('')}
                                    </tbody>
                                </table>
                            `;
                        }
                        return `<p style="color: var(--text-secondary);">${JSON.stringify(result)}</p>`;
                    }).join('');
                } else {
                    resultsDiv.innerHTML = '<p style="color: var(--text-secondary);">No results found.</p>';
                }
                
                document.getElementById(inputId).value = '';
                    } catch (error) {
                resultsDiv.innerHTML = '<p style="color: var(--status-critical);">Failed to query Genie. Please try again.</p>';
            }
        }
        
        // HQ Genie handler
        async function askGenieHQ() {
            await askGenie('hq-genie-input', 'hq-genie-results');
        }
        
        // Property Manager Genie handler
        async function askGenieFollowup() {
            await askGenie('pm-genie-input', 'pm-genie-results');
        }
    </script>
</body>
</html>
